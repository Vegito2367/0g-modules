import { NextResponse } from "next/server";
import * as snarkjs from "snarkjs";

export const runtime = "nodejs";

// Inline the verification key so there is no fs dependency at runtime.
// This was generated by: snarkjs zkey export verificationkey captcha_final.zkey verification_key.json
const VERIFICATION_KEY = {
  protocol: "groth16",
  curve: "bn128",
  nPublic: 1,
  vk_alpha_1: [
    "14006791889059561700382123076175036729926152353303565045738366781962131534804",
    "11670031932232558383970677165936451351314960354120255952632618707526423928286",
    "1",
  ],
  vk_beta_2: [
    [
      "6230409832936498256585168196099693639609865348840849060784314036949651347220",
      "15814930225949379760574566202182194489576365301237389447444224339117516435017",
    ],
    [
      "19759965451284492547215838083042636191435478703617605671260211414362798879994",
      "18485169667592558192509598633354489129439563390690830614302413017167346124558",
    ],
    ["1", "0"],
  ],
  vk_gamma_2: [
    [
      "10857046999023057135944570762232829481370756359578518086990519993285655852781",
      "11559732032986387107991004021392285783925812861821192530917403151452391805634",
    ],
    [
      "8495653923123431417604973247489272438418190587263600148770280649306958101930",
      "4082367875863433681332203403145435568316851327593401208105741076214120093531",
    ],
    ["1", "0"],
  ],
  vk_delta_2: [
    [
      "14140804135927549498644144329496007146674290699153560520873346298209252198802",
      "4055664451385496510177342294075878671301716905080349546584850059910181888947",
    ],
    [
      "190475631735187899615106974630749464304189260007203757800377388105335861201",
      "11527458994833348438282944315290548352662167119181785012042440108233457529312",
    ],
    ["1", "0"],
  ],
  vk_alphabeta_12: [
    [
      [
        "7120865712404912951802351508457938200828003215938147506458609596050428307054",
        "1087940454037552274882806865174003610764471212303432427838054961902128314674",
      ],
      [
        "20619412334008342043819005452385170350525321052899754020212070824071790438089",
        "16837459370344081525995857661037719702154475685528464595252425645227001986788",
      ],
      [
        "15729367804342302505731971747915798880887367757622608971335328619758468340514",
        "3018748322565912201633027708620656986201208464899389591591688100364272991894",
      ],
    ],
    [
      [
        "14008034724995777605659861480423328040048564697637507442927792410659815283422",
        "13878932585242620929143694450536819644511139425333980997777961441554179118963",
      ],
      [
        "11454230880769102035879804258497207628803831907633579887490981129253447438376",
        "923063265997198606283505143023126680411449954070841996302291054482361500698",
      ],
      [
        "13767276648027959567974803133142653391237586906758638799110394380723060446433",
        "3538019236058181442492635556323056439737681472722931839998334940966673262347",
      ],
    ],
  ],
  IC: [
    [
      "20352012475476297541577630758826230447857370789215293628407096975420878188452",
      "17821691346124137089251786549273927471054256303792315317111996552567609058135",
      "1",
    ],
    [
      "16469445506235956136087659701598572459830689509232951435510159531374875427365",
      "6859239646145367151332079434852583652982160193173859356551567190717421881628",
      "1",
    ],
  ],
};

export async function POST(req: Request) {
  try {
    console.log("Received proof validation request. Parsing body...");
    const { proof, publicSignals } = await req.json();

    if (!proof || !publicSignals) {
      return NextResponse.json(
        { verified: false, error: "Missing proof or publicSignals" },
        { status: 400 },
      );
    }

    console.log("Proof and public signals received. Verifying proof...");
    // Verify the Groth16 proof against the embedded verification key
    const isValid = await snarkjs.groth16.verify(
      VERIFICATION_KEY,
      publicSignals,
      proof,
    );

    if (!isValid) {
      return NextResponse.json({ verified: false, error: "Proof verification failed" });
    }
    console.log("Proof verified successfully. Checking circuit output...");

    // The circuit outputs isHuman as publicSignals[0]; must be "1"
    if (publicSignals[0] !== "1") {
      return NextResponse.json({
        verified: false,
        error: "Circuit output isHuman !== 1",
      });
    }

    return NextResponse.json({ verified: true });
  } catch (err: unknown) {
    const msg = err instanceof Error ? err.message : String(err);
    return NextResponse.json(
      { verified: false, error: msg },
      { status: 500 },
    );
  }
}
